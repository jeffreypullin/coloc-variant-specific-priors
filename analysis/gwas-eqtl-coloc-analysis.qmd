---
title: "GWAS-eQTL colocalisation analysis"
format: html
editor: source
---

```{r warning = FALSE, message = FALSE}
renv::load(here::here())

library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(yaml)
library(glue)

devtools::load_all("~/coloc")
```

```{r load-data}
config <- read_yaml(here::here("config.yaml"))
gwas_ids_eqtl_ids <- config$gwas_eqtl_coloc_ids
gwas_eqtl_colocs <- expand_grid(
  chr = 1:22,
  gwas_id_eqtl_id = gwas_ids_eqtl_ids
  ) |>
  separate_wider_delim(gwas_id_eqtl_id, "-", names = c("gwas_id", "eqtl_id")) |>
  rowwise() |>
  mutate(file = here::here(
    glue("output/data/gwas-eqtl-coloc-{gwas_id}-{eqtl_id}-{chr}.rds")
  )) |>
  mutate(data = list(read_rds(file))) |>
  unnest(data)
```

```{r}
gwas_eqtl_colocs |>
  filter(PP.H4.abf_unif > 0.8) |>
  select(gwas_id, eqtl_id, gene_name, 
         PP.H4.abf_unif, PP.H4.abf_abc_score_gwas) |>
  print(n = 100)
```

```{r}
gwas_eqtl_colocs |>
  filter(PP.H4.abf_unif > 0.8) |>
  summarise(n_eqtl_data_ids = n(), .by = gene_name) |>
  arrange(desc(n_eqtl_data_ids)) |>
  print(n = 47)
```

```{r}
gwas_eqtl_colocs |>
  select(gene_name, gwas_id, starts_with("PP.H4.abf")) |>
  pivot_longer(-c(gene_name, gwas_id), values_to = "pp_h4") |>
  mutate(sig_coloc = pp_h4 > 0.8) |>
  summarise(n_sig = sum(sig_coloc), .by = name) |>
  mutate(is_unif = name == "PP.H4.abf_unif") |>
  mutate(name = fct_reorder(factor(name), n_sig)) |>
  ggplot(aes(name, n_sig, fill = is_unif)) + 
  geom_col() + 
  coord_flip() + 
  labs(
    y = "Number of signifcant (Pr(H4) > 0.8) colocalisations", 
    x = "Prior type"
  ) +
  theme_bw() + 
  theme(legend.position = "none")
```

```{r}
gwas_eqtl_colocs |>
  mutate(
    sig_abc_score_gwas = PP.H4.abf_abc_score_gwas > 0.8,
    sig_unif = PP.H4.abf_unif > 0.8
  ) |>
  filter(sig_abc_score_gwas != sig_unif) |>
  select(gwas_id, eqtl_id, gene_name,
         PP.H4.abf_unif, PP.H4.abf_abc_score_gwas)
```

```{r}
gwas_eqtl_colocs |>
  mutate(
    sig_gwas_tss_eqtlgen = PP.H4.abf_gwas_tss_eqtlgen > 0.8,
    sig_unif = PP.H4.abf_unif > 0.8
  ) |>
  filter(sig_gwas_tss_eqtlgen != sig_unif) |>
  select(gwas_id, eqtl_id, gene_name,
         PP.H4.abf_unif, PP.H4.abf_gwas_tss_eqtlgen)
```

```{r}
gwas_eqtl_colocs |>
  filter(gene_name == "GINS2") |>
  select(gwas_id, eqtl_id, gene_name, 
        PP.H4.abf_unif, PP.H4.abf_abc_score_gwas)
```

```{r}
gwas_eqtl_colocs |>
  ggplot(aes(PP.H4.abf_unif, PP.H4.abf_abc_score_gwas)) + 
  geom_point() + 
  geom_hline(yintercept = 0.8, col = "red") + 
  geom_vline(xintercept = 0.8, col = "red") + 
  theme_bw()
```

```{r}
gwas_eqtl_colocs |>
  ggplot(aes(PP.H4.abf_unif, PP.H4.abf_gwas_tss_eqtlgen)) + 
  geom_point() + 
  geom_abline(linetype = "dotted") + 
  geom_hline(yintercept = 0.8, col = "red") + 
  geom_vline(xintercept = 0.8, col = "red") + 
  theme_bw()
```
