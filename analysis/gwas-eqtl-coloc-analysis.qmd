---
title: "GWAS-eQTL colocalisation analysis"
format: html
editor: source
---

```{r warning = FALSE, message = FALSE}
renv::load(here::here())

library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)

devtools::load_all("~/coloc")
```

```{r load-data}
gwas_eqtl_colocs <- expand_grid(
  chr = 1:22
) |>
  rowwise() |>
  mutate(file = paste0(
    here::here("output/data/gwas-eqtl-coloc"), "-", chr, ".rds")
  ) |>
  mutate(data = list(read_rds(file))) |>
  unnest(data)
```

```{r unif-colocs}
gwas_eqtl_colocs |>
  filter(PP.H4.abf_unif >= 0.8) |>
  select(gene_name) |>
  print(n = 30)
```

```{r}
gwas_eqtl_colocs |>
  select(gene_name, starts_with("PP.H4.abf")) |>
  pivot_longer(-gene_name, values_to = "pp_h4") |>
  mutate(sig_coloc = pp_h4 > 0.8) |>
  summarise(n_sig = sum(sig_coloc), .by = name) |>
  mutate(is_unif = name == "PP.H4.abf_unif") |>
  mutate(name = fct_reorder(factor(name), n_sig)) |>
  ggplot(aes(name, n_sig, fill = is_unif)) + 
  geom_col() + 
  coord_flip() + 
  theme_bw()
```

```{r}
gwas_eqtl_colocs |>
  mutate(
    sig_abc_score_gwas = PP.H4.abf_abc_score_gwas > 0.8,
    sig_unif = PP.H4.abf_unif > 0.8
  ) |>
  filter(sig_abc_score_gwas != sig_unif) |>
  select(gene_name, PP.H4.abf_unif , PP.H4.abf_abc_score_gwas)
```

```{r}
gwas_eqtl_colocs |>
  mutate(
    sig_gwas_tss_eqtlgen = PP.H4.abf_gwas_tss_eqtlgen > 0.8,
    sig_unif = PP.H4.abf_unif > 0.8
  ) |>
  filter(sig_gwas_tss_eqtlgen != sig_unif) |>
  select(gene_name, PP.H4.abf_unif , PP.H4.abf_gwas_tss_eqtlgen)
```

```{r}
gwas_eqtl_colocs |>
  ggplot(aes(PP.H4.abf_unif, PP.H4.abf_abc_score_gwas)) + 
  geom_point() + 
  geom_abline(linetype = "dotted") + 
  geom_hline(yintercept = 0.8, col = "red") + 
  geom_vline(xintercept = 0.8, col = "red") + 
  theme_bw()
```

