---
title: "Finemapping analysis"
format: html
editor: source
---

```{r warning = FALSE, message = FALSE}
renv::load(here::here())

library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)

devtools::load_all("~/coloc")
```

```{r}
compute_credible_set <- function(pips, alpha = 0.95) {
  pips_order <- order(pips, decreasing = TRUE)
  cum_pips <- cumsum(pips[pips_order])
  cs_size <- which.max(cum_pips >= alpha) 
  pips_order[1:cs_size]
}
```

```{r load-data}
gwas_eqtl_finemapping <- expand_grid(
  chr = 1:22
) |>
  rowwise() |>
  mutate(file = paste0(
    here::here("output/data/gwas-eqtl-finemapping"), "-", chr, ".rds")
  ) |>
  mutate(data = list(read_rds(file))) |>
  unnest(data)
```

```{r}
cs_n_data <- gwas_eqtl_finemapping |>
  select(gene_name, ends_with("eqtl"), ends_with("gwas")) |>
  pivot_longer(-gene_name, values_to = "pip") |>
  summarise(cs = list(compute_credible_set(pip)), 
            .by = c(gene_name, name)) |>
  rowwise() |>
  mutate(cs_n = length(cs)) |>
  ungroup()
```

```{r}
cs_n_data |>
  mutate(name = fct_reorder(factor(name), cs_n)) |>
  ggplot(aes(name, log(cs_n))) + 
  geom_boxplot() + 
  coord_flip() +
  theme_bw()
```

```{r}
cs_n_data |>
  mutate(single_cs = cs_n == 1) |>
  summarise(prop_single_cs = sum(single_cs) / n(), .by = name) |>
  mutate(name = fct_reorder(factor(name), prop_single_cs)) |>
  ggplot(aes(name, prop_single_cs)) + 
  geom_point() + 
  coord_flip() +
  theme_bw()
```

```{r}
cs_n_data |>
  filter(cs_n <= 20) |>
  count(cs_n, name) |>
  ggplot(aes(cs_n, n)) + 
  geom_col() + 
  labs(
    y = "Count",
    x = "Size of single-causal variant CS"
  ) + 
  facet_wrap(~name) + 
  theme_bw()
```